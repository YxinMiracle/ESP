# Unwrapping Ursnifs Gifts

> Source link: https://thedfirreport.com/2023/01/09/unwrapping-ursnifs-gifts/
>
> Rewritten section: Execution



- Rewritten content：

```
Once the malware was executed, the parent instance of explorer launched MSHTA with the following command:
"C:\Windows\System32\mshta.exe" "about:<hta:application><script>Cxak='wscript.shell';resizeTo(0,2);eval(new ActiveXObject(Cxak).regread('HKCU\\\Software\\AppDataLow\\Software\\Microsoft\\472A62F9-FA62-1196-3C6B-CED530CFE2D9\\\ActiveDevice'));if(!window.flag)close()</script>"
```



- Manually written Sigma rules：

https://github.com/The-DFIR-Report/Sigma-Rules/blob/fc909a8ed85ba8a8cceab2f8102cdff4627a534e/rules/windows/process_creation/proc_creation_win_mshta.yml#L4

```sigma
title: Mshta Executing from Registry
id: 8f6de20d-0616-4cf1-875e-24ccabb2e78c
status: Experimental
description: Detects a Mshta executing code from the registry
author: TheDFIRReport
references:
    - https://lolbas-project.github.io/lolbas/Binaries/Mshta/
    - https://thedfirreport.com/2023/01/09/unwrapping-ursnifs-gifts
date: 2023-01-08
logsource:
    category: process_creation
    product: windows
detection:
    selection:
        CommandLine|contains|all:
            - 'wscript.shell'
            - 'new ActiveXObject'
            - 'regread'
        Image|endswith: 'mshta.exe'
    condition: selection
fields:
    - CommandLine
falsepositives:
    - Unknown
level: high
tags:
    - attack.defense-evasion
    - attack.t1218.005
```



- ESP Rule

```
title: Suspicious MSHTA JavaScript Execution
description: Detects execution of malicious JavaScript via MSHTA for code execution, associated with Defense Evasion and Execution.
logsource:
    category: process_creation
    product: windows
detection:
    selection_image:
        Image|endswith: "mshta.exe"
    selection_command:
        CommandLine|contains|all:
            - "about:<hta:application>"
            - "eval(new ActiveXObject"
            - "regread"
            - "HKCU\\Software\\"
condition: selection_image and selection_command
level: high
tags:
    - attack.t1218.005
    - attack.t1059.007
```

