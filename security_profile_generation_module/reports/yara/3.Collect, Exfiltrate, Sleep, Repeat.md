# Collect, Exfiltrate, Sleep, Repeat



> Source link: https://thedfirreport.com/2023/02/06/collect-exfiltrate-sleep-repeat/
>
> Rewritten section: Persistence (readKey.ps1)



- Rewritten content：

```
The attacker utilized a malicious VBA macro to create a scheduled task on the target system, which, upon triggering, executed C:\Users\Public\module\module.exe and passed C:\Users\Public\module\module.ahk as an argument. module.exe is a malicious payload designed to perform further malicious actions, such as keystroke logging and data theft. To bypass security defenses, the attacker also used PowerShell to execute the readKey.ps1 script with the following command: powershell -ep bypass -windowstyle hidden -f "C:\Users\Public\module\readKey.ps1". The -ep bypass parameter allowed PowerShell to bypass the execution policy, enabling the execution of unsigned scripts, while the -windowstyle hidden flag ensured that PowerShell ran in the background without detection. The -f parameter specified the path to the malicious script. Through these actions, the attacker ensured the covert execution of the malicious scripts, maintaining persistent control over the system and facilitating the theft of sensitive information or execution of additional malicious tasks. Additionally, the attacker created a scheduled task configuration file named t.xml (hash: 7ae52c0562755f909d5d79c81bb99ee2403f2c2ee4d53fd1ba7692c8053a63f6), further strengthening their persistent control over the target system and ensuring that the malicious tasks remained active even after a system reboot.
```



- Manually written YARA rules

https://github.com/The-DFIR-Report/Yara-Rules/blob/b7d513e2eed3c00bb31cf420b6bf174cd2bbc8fe/17333/17333.yar#L50 （sig_17333_t ）

```yara
rule sig_17333_t {
   meta:
      description = "17333 - file t.xml"
      author = "The DFIR Report"
      reference = "https://thedfirreport.com/2023/02/06/collect-exfiltrate-sleep-repeat/"
      date = "2023-02-03"
      hash1 = "7ae52c0562755f909d5d79c81bb99ee2403f2c2ee4d53fd1ba7692c8053a63f6"
   strings:
      $x1 = "      <Arguments>-ep bypass -windowstyle hidden -f \"C:\\Users\\Public\\module\\readKey.ps1\"</Arguments>" fullword wide
      $x2 = "      <Command>\"C:\\Users\\Public\\module\\module.exe\"</Command>" fullword wide
      $s3 = "      <Arguments>\"C:\\Users\\Public\\module\\module.ahk\"</Arguments>" fullword wide
      $s4 = "      <Command>powershell</Command>" fullword wide
      $s5 = "    <ExecutionTimeLimit>PT72H</ExecutionTimeLimit>" fullword wide
      $s6 = "  <Actions Context=\"Author\">" fullword wide
      $s7 = "    <Exec>" fullword wide
      $s8 = "    </Exec>" fullword wide
      $s9 = "    <LogonTrigger>" fullword wide
      $s10 = "    </LogonTrigger>" fullword wide
      $s11 = "      <LogonType>InteractiveToken</LogonType>" fullword wide
      $s12 = "      <RunLevel>LeastPrivilege</RunLevel>" fullword wide
      $s13 = "  </Actions>" fullword wide
      $s14 = "  </Settings>" fullword wide
      $s15 = "  </RegistrationInfo>" fullword wide
      $s16 = "  <Settings>" fullword wide
      $s17 = "  </Principals>" fullword wide
      $s18 = "  <Principals>" fullword wide
      $s19 = "  <RegistrationInfo>" fullword wide
      $s20 = "<Task version=\"1.2\" xmlns=\"http://schemas.microsoft.com/windows/2004/02/mit/task\">" fullword wide /* Goodware String - occured 1 times */
   condition:
      uint16(0) == 0xfeff and filesize < 10KB and
      1 of ($x*) and 4 of them
}
```



- ESP rule

```
rule Script_Module_Detection {
    meta:
        description = "Detects suspicious script and module files associated with potential malicious activity"
        reference = "ESP Intelligence"
        author = "ESP"
        date = "2025-01-01"
        hash1 = "7ae52c0562755f909d5d79c81bb99ee2403f2c2ee4d53fd1ba7692c8053a63f6"
    strings:
        $script1 = "readKey.ps1" ascii wide
        $script2 = "t.xml" ascii wide
        $moduleAhk = "C:\\Users\\Public\\module\\module.ahk" ascii wide
        $moduleExe = "C:\\Users\\Public\\module\\module.exe" ascii wide
        $moduleExeShort = "module.exe" ascii wide
    condition:
        any of them
}
```

