# Unwrapping Ursnifs Gifts

> Source link: https://thedfirreport.com/2023/01/09/unwrapping-ursnifs-gifts/
>
> Rewritten section: Discovery (check.exe)



- Rewritten content：

```
After conducting initial network reconnaissance through Ursnif malware and Cobalt Strike penetration tools, the attackers discovered a support account with domain administrator privileges and immediately launched an in-depth penetration of the Active Directory environment. The attackers carefully crafted an automated script named adcomp.bat, which executed a crucial PowerShell command via cmd.exe: "powershell Get-ADComputer -Filter * -Properties Name,Operatingsystem,OperatingSystemVersion,OperatingSystemServicePack,IPv4Address >> log2.txt". This command comprehensively enumerated all computer objects within the domain, precisely obtaining core asset information including hostnames (Name), operating system types (Operatingsystem), system versions (OperatingSystemVersion), service pack statuses (OperatingSystemServicePack), and IP addresses (IPv4Address), with all results being completely recorded in the log2.txt file. This systematic information collection not only provided the attackers with a clear network topology but also accurately identified high-value targets, laying a solid foundation for subsequent lateral movement and privilege escalation, fully demonstrating the attackers' deep understanding of domain environments and mature attack techniques.
```



- Manually written YARA rules

https://github.com/The-DFIR-Report/Yara-Rules/blob/b7d513e2eed3c00bb31cf420b6bf174cd2bbc8fe/17386/17386.yar#L40 （gozi_17386_adcomp_bat）

```yara
rule gozi_17386_adcomp_bat
{
	meta:
		description = "Gozi - file adcomp.bat"
		author = "The DFIR Report"
		reference = "https://thedfirreport.com/2023/01/09/unwrapping-ursnifs-gifts"
		date = "2023-01-08"
		hash1 = "eb2335e887875619b24b9c48396d4d48"
	strings:
		$s1 = "powershell" fullword
		$s2 = ">> log2.txt" fullword
		$s3 = "Get-ADComputer" fullword
	condition:
		$s1 at 0 and
		filesize < 500 and
		all of them
}
```



- ESP Rule

```
rule Ursnif_CobaltStrike_ADRecon {
    meta:
        description = "Detects artifacts related to Ursnif and Cobalt Strike malware used for Active Directory reconnaissance"
        reference = "ESP Intelligence"
        author = "ESP"
        date = "2025-01-01"
        hash1 = "eb2335e887875619b24b9c48396d4d48"
    strings:
        $malware1 = "Ursnif"
        $malware2 = "Cobalt Strike"
        $file1 = "log2.txt"
        $file2 = "adcomp.bat"
        $file3 = 'powershell'
    condition:
        any of them
}
```

